<!DOCTYPE html>
<html lang="nl">
<head><script type="text/javascript" src="/___vscode_livepreview_injected_script"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>One Vibe ‚Äî Avatar Builder (Ready Player Me)</title>

  <!-- Styles (unchanged) -->
  <style>
    :root{ --accent:#73F7FF; --bg:#0a0f14; --fg:#eaf6ff; }
    *{box-sizing:border-box} html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header, footer, .pill, .row, .btn, code, #frameWrap, #loader, .spinner, .url, .hidden {
      /* Use existing styles from your file ‚Äì omitting here for brevity */
    }
    model-viewer {
      margin-top: 16px;
      width: 100%;
      height: 480px;
      display: none;
      background: #0c1016;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }
  </style>

  <!-- Load model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- Load Three.js + GLTFExporter -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.156.1/build/three.module.js';
    import { GLTFExporter } from 'https://unpkg.com/three@0.156.1/examples/jsm/exporters/GLTFExporter.js';
    window.THREE = THREE;
    window.GLTFExporter = GLTFExporter;
  </script>
</head>

<body>
  <header>
    <!-- existing header UI... -->
  </header>

  <main>
    <div id="frameWrap">
      <iframe id="frame" allow="camera *; microphone *; clipboard-write" referrerpolicy="origin"></iframe>
      <div id="loader"><div class="spinner" aria-label="Laden‚Ä¶"></div></div>
    </div>
    <p style="margin-top:12px">
      Tip: jouw custom subdomein wordt gebruikt. Zet <code>window.ONEVIBE_RPM_SUBDOMAIN</code> vooraf als je dit wil overschrijven.
      De laatste export wordt opgeslagen in <code>localStorage.ov_avatar_glb</code>.
    </p>

    <!-- üéâ Live 3D Viewer -->
    <model-viewer id="avatarViewer" camera-controls auto-rotate ar alt="Jouw avatar preview"></model-viewer>

    <!-- üîò Avatar Tools -->
    <div id="modelActions" class="row" style="margin-top: 10px; display: none;">
      <a id="dragDownload" class="btn btn--ghost" href="#" draggable="true" download="avatar.glb">‚¨áÔ∏è Drag to Download</a>
      <button id="snapshotBtn" class="btn">üì∏ Snapshot</button>
    </div>

    <div class="row" style="margin-top: 10px; flex-wrap: wrap; gap: 8px;">
      <label style="display:flex;align-items:center;gap:8px;">
        Achtergrond:
        <input id="bgColor" type="color" value="#0c1016" style="border:none;background:none;">
      </label>
      <button id="exportGLTF" class="btn btn--ghost">üß¨ Exporteer GLTF</button>
      <a id="exportUSDZ" class="btn btn--ghost hidden" href="#" target="_blank" download>üçè Download USDZ</a>
    </div>
  </main>

  <footer>One Vibe ‚Ä¢ Ready Player Me embed ‚Ä¢ v2</footer>

  <!-- üîß JS Logic -->
  <script>
    const DEFAULT_SUBDOMAIN = "avatars-7zf78o";
    const subdomain = (window.ONEVIBE_RPM_SUBDOMAIN || DEFAULT_SUBDOMAIN).replace(/\/$/, "");
    const RPM_ORIGIN = `https://${subdomain}.readyplayer.me`;
    const FRAME_URL = `${RPM_ORIGIN}/avatar?frameApi`;

    const frame = document.getElementById("frame");
    const loader = document.getElementById("loader");
    const openBtn = document.getElementById("openBtn");
    const closeBtn = document.getElementById("closeBtn");
    const resetBtn = document.getElementById("resetBtn");
    const copyBtn = document.getElementById("copyBtn");
    const viewBtn = document.getElementById("viewBtn");
    const avatarUrlEl = document.getElementById("avatarUrl");

    const modelViewer = document.getElementById("avatarViewer");
    const dragDownload = document.getElementById("dragDownload");
    const snapshotBtn = document.getElementById("snapshotBtn");
    const modelActions = document.getElementById("modelActions");
    const bgColorPicker = document.getElementById("bgColor");
    const exportGLTFBtn = document.getElementById("exportGLTF");
    const exportUSDZ = document.getElementById("exportUSDZ");

    const vibrate = (ms = 12) => { if (navigator.vibrate) try { navigator.vibrate(ms); } catch(_){} };
    const show = el => el.style.display = "";
    const hide = el => el.style.display = "none";

    const maybeSetUSDZ = (url) => {
      if (url.endsWith(".glb")) {
        exportUSDZ.href = url.replace(/\.glb$/, ".usdz");
        exportUSDZ.classList.remove("hidden");
      }
    };

    const setUrl = (url) => {
      if (url) {
        localStorage.setItem("ov_avatar_glb", url);
        avatarUrlEl.textContent = url;
        viewBtn.href = url;
        viewBtn.classList.remove("hidden");
        modelViewer.src = url;
        modelViewer.style.display = "";
        modelActions.style.display = "flex";
        dragDownload.href = url;
        maybeSetUSDZ(url);
      } else {
        avatarUrlEl.textContent = "‚Äî";
        viewBtn.classList.add("hidden");
        modelViewer.src = "";
        modelViewer.style.display = "none";
        modelActions.style.display = "none";
        dragDownload.href = "#";
        exportUSDZ.classList.add("hidden");
      }
    };

    frame.src = FRAME_URL;
    setUrl(localStorage.getItem("ov_avatar_glb"));

    function parseMsg(event){
      try { return JSON.parse(event.data); } catch(e){ return null; }
    }

    function onMessage(event){
      if (event.origin !== RPM_ORIGIN) return;
      const data = parseMsg(event);
      if(!data || data.source !== "readyplayerme") return;

      if(data.eventName === "v1.frame.ready"){
        frame.contentWindow.postMessage(JSON.stringify({
          target: "readyplayerme",
          type: "subscribe",
          eventName: "v1.**"
        }), RPM_ORIGIN);
        hide(loader);
        show(frame);
      }

      if(data.eventName === "v1.avatar.exported"){
        const url = data?.data?.url;
        if(url){
          setUrl(url);
          hide(frame);
        }
      }
    }

    window.addEventListener("message", onMessage, false);

    openBtn?.addEventListener("click", ()=> {
      vibrate(20);
      openBtn.style.transform = "scale(.96)";
      setTimeout(()=> openBtn.style.transform = "", 80);
      show(loader);
      show(frame);
      frame.focus();
      if (frame.src !== FRAME_URL) frame.src = FRAME_URL;
    });

    closeBtn?.addEventListener("click", ()=> {
      vibrate(10);
      hide(frame);
      hide(loader);
    });

    resetBtn?.addEventListener("click", ()=> {
      localStorage.removeItem("ov_avatar_glb");
      setUrl("");
    });

    copyBtn?.addEventListener("click", async ()=> {
      const text = avatarUrlEl.textContent.trim();
      if (!text || text === "‚Äî") return;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = "Gekopieerd!";
        setTimeout(()=> copyBtn.textContent = "Kopieer", 900);
        vibrate(10);
      } catch (e) {
        alert("Kon URL niet kopi√´ren. Selecteer en kopieer handmatig.");
      }
    });

    window.addEventListener("keydown", (e)=> {
      if (e.key === "Escape") { hide(frame); hide(loader); }
    });

    snapshotBtn?.addEventListener("click", async () => {
      const canvas = modelViewer.shadowRoot.querySelector("canvas");
      if (!canvas) return alert("Kan snapshot niet nemen üò¢");
      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "avatar-snapshot.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      vibrate(20);
    });

    bgColorPicker?.addEventListener("input", () => {
      modelViewer.style.backgroundColor = bgColorPicker.value;
    });

    exportGLTFBtn?.addEventListener("click", async () => {
      const scene = modelViewer?.threeRenderer?.scene;
      if (!scene || !window.GLTFExporter) return alert("Kan GLTF niet exporteren");
      const exporter = new window.GLTFExporter();
      exporter.parse(scene, (result) => {
        const gltf = JSON.stringify(result);
        const blob = new Blob([gltf], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "avatar-export.gltf";
        a.click();
        URL.revokeObjectURL(url);
        vibrate(20);
      });
    });
  </script>
</body>
</html>
